var ImageCropper={croppingActive:!1,dragging:!1,imageDimensions:{},imageUrlParams:{},manifestAttribution:null,manifestLabel:null,resizing:!1,options:{},locales:{de:{approx:"ca.",bitonal:"bitonal",color:"in Farbe",default:"Voreinstellung",gray:"in Graustufen","license-message":"Bitte beachten Sie die Lizenzinformationen",options:"Optionen",pixel:"Pixel",preview:"Vorschau","preview-image-error":"Die ausgewählten Parameter werden für diese Ressource leider nicht unterstützt!","preview-image-link":"In oben ausgewählter Größe anzeigen",quality:"Qualität","region-link":"Link zum ausgewählten Ausschnitt",rotation:"Rotation","selected-size":"Ausgewählte Größe",size:"Größe","toggle-cropping":"Auswahl eines Bildausschnitts aktivieren"},en:{approx:"approx.",bitonal:"bitonal",color:"in color",default:"default",gray:"in gray scale","license-message":"Please note the license information",options:"Options",pixel:"pixels",preview:"Preview","preview-image-error":"The selected parameters are not supported for this resource!","preview-image-link":"Show in size selected above",quality:"Quality","region-link":"Link to the selected region",rotation:"Rotation","selected-size":"Selected size",size:"Size","toggle-cropping":"Toggle image cropping"}},buttonTemplate:Mirador.Handlebars.compile(['<div class="cropping-controls">','<a class="cropping-toggle hud-control{{#if active}} active{{/if}}" role="button" title="{{t "toggle-cropping"}}" aria-label="{{t "toggle-cropping"}}">','<i class="fa fa-lg fa-crop"></i>',"</a>","</div>"].join("")),croppingOverlayTemplate:Mirador.Handlebars.compile(['<div class="cropping-overlay">','<span class="fa-stack share-button"><i class="fa fa-square-o fa-stack-2x"></i>','<i class="fa fa-share-alt fa-stack-1x"></i></span>','<div class="resize-frame"></div>',"{{#each resizeControls.anchors}}",'<div class="resize-anchor {{this}}"></div>',"{{/each}}","{{#each resizeControls.bars}}",'<div class="resize-bar {{this}}"></div>',"{{/each}}","</div>"].join("")),imageUrlTemplate:Mirador.Handlebars.compile("{{imageBaseUrl}}/pct:{{region.relative.x}},{{region.relative.y}},{{region.relative.w}},{{region.relative.h}}/{{size}}/{{rotation}}/{{quality}}.jpg"),modalTemplate:Mirador.Handlebars.compile(['<div id="image-cropper-modal" class="modal fade" tabindex="-1" role="dialog" data-backdrop="false">','<div class="modal-dialog" role="document">','<div class="modal-content">','<div class="modal-header">','<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>','<h4 class="modal-title">{{t "region-link"}}</h4>',"</div>",'<div class="modal-body">','<input id="image-url" type="text" value="{{imageUrl}}">','<button type="button" class="btn btn-default" id="copy-to-clipboard" title="{{t "copy-to-clipboard"}}">','<i class="fa fa-clipboard" aria-hidden="true"></i>',"</button>",'<div id="options">','<h4 class="block-title">{{t "options"}}</h4>','<div class="option-type size">{{t "size"}}:</div>','<input id="size-selector" type="range" min="1" name="size" value="100">','<span id="size-label">{{t "selected-size"}}:<span id="relative">100%</span>','({{t "approx"}}<span id="absolute">{{imageUrlParams.region.w}}x{{imageUrlParams.region.h}}</span>{{t "pixel"}})</span>','<div class="option-type rotation">{{t "rotation"}}:</div>','<label class="radio-inline"><input type="radio" name="rotation" value="0" checked>0°</label>','<label class="radio-inline"><input type="radio" name="rotation" value="90">90°</label>','<label class="radio-inline"><input type="radio" name="rotation" value="180">180°</label>','<label class="radio-inline"><input type="radio" name="rotation" value="270">270°</label>','<div class="option-type quality">{{t "quality"}}:</div>','<label class="radio-inline"><input type="radio" name="quality" value="{{imageUrlParams.quality}}" checked>{{t "default"}}</label>','<label class="radio-inline"><input type="radio" name="quality" value="color">{{t "color"}}</label>','<label class="radio-inline"><input type="radio" name="quality" value="gray">{{t "gray"}}</label>','<label class="radio-inline"><input type="radio" name="quality" value="bitonal">{{t "bitonal"}}</label>',"<hr>","</div>",'<div id="preview">','<h4 class="block-title">{{t "preview"}} <i class="fa fa-spinner fa-spin" aria-hidden="true"></i></h4>','<h5><a href="{{imageUrl}}" id="preview-image-link" target="_blank">{{t "preview-image-link"}}</a></h5>','<img id="preview-image" alt="{{t "preview-image-error"}}" src="{{imageUrl}}">',"</div>","{{#if licenseUrl}}",'<div id="license-message" class="alert alert-warning" role="alert">','{{t "license-message"}}:','<a href="{{licenseUrl}}" id="license-link" target="_blank">{{licenseUrl}}</a>',"</div>","{{/if}}","</div>",'<div class="modal-footer">','<button type="button" class="btn btn-default" data-dismiss="modal">{{t "close"}}</button>',"</div>","</div>","</div>","</div>",'<div class="modal-backdrop fade in"></div>'].join("")),addLocalesToViewer:function(){var e={};for(var i in this.locales)e=this.locales[i],void 0!==window.ShareButtons&&ShareButtons.locales[i]&&$.extend(e,ShareButtons.locales[i]),i18next.addResources(i,"translation",e)},addModalEventHandlers:function(){$(document.body).on("click","#image-cropper-modal #copy-to-clipboard",function(){$("#image-cropper-modal #image-url").select(),document.execCommand("copy")}),$(document.body).on("change",'input[name="size"], input[name="rotation"], input[name="quality"]',function(e){var i=$(e.target).attr("name"),t=$(e.target).closest("#options").find("#size-selector").val();if("size"===i?(this.imageUrlParams.size="pct:"+t,$("#image-cropper-modal #size-label > #relative").text(t+"%")):"rotation"===i?this.imageUrlParams.rotation=$(e.target).val():"quality"===i&&(this.imageUrlParams.quality=$(e.target).val()),-1!==["size","rotation"].indexOf(i)){var a=Math.ceil(t/100*this.imageUrlParams.region.w),o=Math.ceil(t/100*this.imageUrlParams.region.h);$("#image-cropper-modal #size-label > #absolute").text(-1!==[0,180].indexOf(parseInt(this.imageUrlParams.rotation))?a+"x"+o:o+"x"+a)}var n=this.imageUrlTemplate(this.imageUrlParams);$("#image-cropper-modal #image-url").val(n).select(),$("#image-cropper-modal #preview-image-link").attr("href",n),$("#image-cropper-modal .fa-spinner").addClass("fa-spin").show(),$("#image-cropper-modal #preview-image").attr("src",this.imageUrlTemplate($.extend({},this.imageUrlParams,{size:"full"}))).on("error load",function(){$("#image-cropper-modal .fa-spinner").hide().removeClass("fa-spin")}),void 0!==window.ShareButtons&&ShareButtons.updateButtonLinks({attribution:this.manifestAttribution,label:this.manifestLabel,link:n,thumbnailUrl:this.imageUrlTemplate($.extend({},this.imageUrlParams,{size:"280,"}))})}.bind(this))},calculateImageBounds:function(e,i){return{topLeft:e.imageToWindowCoordinates(new OpenSeadragon.Point(0,0)),topRight:e.imageToWindowCoordinates(new OpenSeadragon.Point(this.imageDimensions[i].width,0)),bottomLeft:e.imageToWindowCoordinates(new OpenSeadragon.Point(0,this.imageDimensions[i].height))}},calculateImageCoordinates:function(e,i,t,a,o){t&&(e.top+=5,e.left+=5,e.height-=5,e.width-=5);var n=new OpenSeadragon.Point(e.left,e.top),s=new OpenSeadragon.Point(e.left+e.width,e.top),r=new OpenSeadragon.Point(e.left,e.top+e.height),l=i.viewportToImageCoordinates(i.viewport.pointFromPixelNoRotate(n)),p=i.viewportToImageCoordinates(i.viewport.pointFromPixelNoRotate(s)),d=i.viewportToImageCoordinates(i.viewport.pointFromPixelNoRotate(r)),c={x:Math.floor(l.x),y:Math.floor(l.y),w:Math.ceil(p.x-l.x),h:Math.ceil(d.y-l.y)};if(t&&(c.x=Math.max(0,c.x),c.y=Math.max(0,c.y),c.w=Math.min(c.w,this.imageDimensions[o].width),c.h=Math.min(c.h,this.imageDimensions[o].height)),a){var m=this.options.roundingPrecision;("number"!=typeof m||m<0||m>20)&&(m=5),c.relative={},c.relative.x=parseFloat((c.x/this.imageDimensions[o].width*100).toFixed(m)),c.relative.y=parseFloat((c.y/this.imageDimensions[o].height*100).toFixed(m)),c.relative.w=parseFloat((c.w/this.imageDimensions[o].width*100).toFixed(m)),c.relative.h=parseFloat((c.h/this.imageDimensions[o].height*100).toFixed(m))}return c},calculatePositions:function(e,i){return{element:e.offset(),mouse:{top:i.pageY,left:i.pageX}}},changeOverlayDimensions:function(e,i,t,a,o,n){var s=this.calculateImageBounds(o,n);if(i.top<s.topLeft.y||i.left<s.topLeft.x||i.top>s.bottomLeft.y||i.left>s.topRight.x)this.resizing=!1;else{var r=a.position(),l=a.height(),p=a.width();"top-left"!==e&&"top"!==e&&"top-right"!==e||(r.top=i.top-t.canvas.top,l=a.height()+(a.position().top-r.top)),"top-right"!==e&&"right"!==e&&"bottom-right"!==e||(p=i.left-t.element.left),"bottom-left"!==e&&"bottom"!==e&&"bottom-right"!==e||(l=i.top-t.element.top),"bottom-left"!==e&&"left"!==e&&"top-left"!==e||(r.left=i.left-t.canvas.left,p=a.width()+(a.position().left-r.left)),l>=60&&p>=60?a.css({top:r.top,left:r.left,height:l,width:p}):this.resizing=!1}},changeOverlayPosition:function(e,i,t,a,o,n){var s=e.mouse.top-i.canvas.top-i.mouse.y,r=e.mouse.left-i.canvas.left-i.mouse.x,l=t.height(),p=t.width(),d=this.calculateImageCoordinates({top:s,left:r,height:l,width:p},o,!1,!1),c=this.calculateImageBounds(o,n);d.y<-5&&(s=c.topLeft.y-i.canvas.top-5),s<-5&&(s=-5),d.x<-5&&(r=c.topLeft.x-i.canvas.left-5),r<-5&&(r=-5),d.y+d.h>this.imageDimensions[n].height&&(s=c.bottomLeft.y-i.canvas.top-l),s+l>$(a).height()&&(s=$(a).height()-l),d.x+d.w>this.imageDimensions[n].width&&(r=c.topRight.x-i.canvas.left-p),r+p>$(a).width()&&(r=$(a).width()-p),t.css({top:s,left:r})},generateImageUrl:function(e,i){var t=e.imagesList[e.currentImgIndex],a=t.images[0].resource.service||t.images[0].resource.default.service,o=$.extend($(i).closest(".cropping-overlay").position(),{height:$(i).closest(".cropping-overlay").height(),width:$(i).closest(".cropping-overlay").width()}),n=e.canvases[e.canvasID].getVisibleImages()[0].osdTiledImage;return this.imageUrlParams={imageBaseUrl:Mirador.Iiif.getImageUrl(t),region:this.calculateImageCoordinates(o,n,!0,!0,e.windowId),size:"full",rotation:0,quality:"2.0"===Mirador.Iiif.getVersionFromContext(a["@context"])?"default":"native"},this.imageUrlTemplate(this.imageUrlParams)},getLicenseInformation:function(e){var i=e.manifest.jsonLd.license;return this.options.showLicense&&void 0!==i?$(Mirador.MetadataView.prototype.addLinksToUris(i)).attr("href"):null},init:function(){i18next.on("initialized",function(){this.addLocalesToViewer()}.bind(this)),this.injectShareButtonEventHandler(),this.injectButtonToCanvasControls(),this.injectDraggingEventHandlers(),this.injectResizingEventHandlers(),this.injectViewerEventHandler(),this.injectWindowEventHandler(),this.injectOverlayToCanvas()},injectButtonToCanvasControls:function(){var e=this,i=Mirador.Hud.prototype.init;Mirador.Hud.prototype.init=function(){if(i.apply(this),this.appendTo.hasClass("image-view")){e.croppingActive=e.options.activeOnStart||!1;var t=$(e.buttonTemplate({active:e.croppingActive}));t.appendTo(this.appendTo.find(".mirador-osd-context-controls")),$(".cropping-toggle",t).click(function(){$(this).toggleClass("active"),$(this).closest(".image-view").find(".cropping-overlay").toggle()})}}},injectDraggingEventHandlers:function(){var e,i=this,t={},a=Mirador.ImageView.prototype.listenForActions;Mirador.ImageView.prototype.listenForActions=function(){a.apply(this),this.element.on("mousedown",".cropping-overlay > .resize-frame",function(a){1===a.which&&(i.dragging=!0,e=i.calculatePositions($(this).parent(),a),t.canvas=$(this).closest(".mirador-osd").offset(),t.mouse={x:e.mouse.left-e.element.left,y:e.mouse.top-e.element.top})}).on("mousemove",".mirador-osd",function(a){if(i.dragging){a.preventDefault(),e=i.calculatePositions(this.croppingOverlay,a);var o=this.canvases[this.canvasID].getVisibleImages()[0].osdTiledImage;i.changeOverlayPosition(e,t,this.croppingOverlay,a.currentTarget,o,this.windowId)}}.bind(this)).on("mouseup",".cropping-overlay > .resize-frame",function(){i.dragging=!1})}},injectModalToViewerWindow:function(e,i){var t=this.generateImageUrl(e,i),a=this.getLicenseInformation(e);e.element[0].insertAdjacentHTML("beforeend",this.modalTemplate({imageUrl:t,imageUrlParams:this.imageUrlParams,licenseUrl:a})),$("#image-cropper-modal").on("show.bs.modal",function(){void 0!==window.ShareButtons&&(this.setManifestData(e.manifest.jsonLd),ShareButtons.injectButtonsToDom("#image-cropper-modal .modal-footer","afterbegin"),ShareButtons.updateButtonLinks({attribution:this.manifestAttribution,label:this.manifestLabel,link:t,thumbnailUrl:this.imageUrlTemplate($.extend({},this.imageUrlParams,{size:"280,"}))}))}.bind(this)),$("#image-cropper-modal").on("shown.bs.modal",function(){$("#image-cropper-modal #image-url").select()}),$("#image-cropper-modal").on("hidden.bs.modal",function(){$(this).siblings(".modal-backdrop").remove(),$(this).remove()}),$("#image-cropper-modal").on("click",function(e){e.target===this&&$(this).modal("hide")}),$("#image-cropper-modal #preview-image").on("error load",function(){$("#image-cropper-modal .fa-spinner").hide().removeClass("fa-spin")}),$("#image-cropper-modal").modal("show")},injectOverlayToCanvas:function(){var e=this,i=Mirador.ImageView.prototype.init;Mirador.ImageView.prototype.init=function(){i.apply(this);var t=$(e.croppingOverlayTemplate({resizeControls:{anchors:["top-left","top-right","bottom-right","bottom-left"],bars:["top","right","bottom","left"]}}));t.appendTo(this.appendTo.find(".mirador-osd")),this.croppingOverlay=t,e.croppingActive?t.show():t.hide()}},injectResizingEventHandlers:function(){var e,i,t=this,a={},o=Mirador.ImageView.prototype.listenForActions;Mirador.ImageView.prototype.listenForActions=function(){o.apply(this),this.element.on("mousedown",".resize-anchor, .resize-bar",function(i){1===i.which&&(e=i.target.className.split(" ").pop(),t.resizing=!0,a.canvas=$(this).closest(".mirador-osd").offset(),a.element=$(this).parent().offset())}).on("mousemove",".mirador-osd",function(o){if(t.resizing){o.preventDefault(),i=t.calculatePositions(this.croppingOverlay,o).mouse;var n=this.canvases[this.canvasID].getVisibleImages()[0].osdTiledImage;t.changeOverlayDimensions(e,i,a,this.croppingOverlay,n,this.windowId)}}.bind(this)).on("mouseup",".mirador-osd",function(){t.resizing=!1})}},injectShareButtonEventHandler:function(){var e=this,i=Mirador.ImageView.prototype.bindEvents;Mirador.ImageView.prototype.bindEvents=function(){i.apply(this),this.element.on("click",".cropping-overlay > .share-button",function(i){e.injectModalToViewerWindow(this,i.target)}.bind(this))}},injectViewerEventHandler:function(){var e=this,i=Mirador.Viewer.prototype.setupViewer;Mirador.Viewer.prototype.setupViewer=function(){i.apply(this);var t=this.state.getStateProperty("imageCropper");$.isPlainObject(t)&&(e.options=t),void 0!==window.ShareButtons&&ShareButtons.init(e.options.showShareButtonsInfo)},this.addModalEventHandlers()},injectWindowEventHandler:function(){var e=this,i=Mirador.Window.prototype.listenForActions;Mirador.Window.prototype.listenForActions=function(){i.apply(this),this.eventEmitter.subscribe("windowUpdated",function(i,t){this.id===t.id&&t.viewType&&"ImageView"===t.viewType&&(e.imageDimensions[this.id]={height:this.canvases[t.canvasID].canvas.height,width:this.canvases[t.canvasID].canvas.width})}.bind(this))}},setManifestData:function(e){this.manifestAttribution=e.attribution,this.manifestLabel=e.label}};$(document).ready(function(){ImageCropper.init()});